<!DOCTYPE html>
<html
  th:replace="~{modules/layout :: html (title = '瞬间', content = ~{::content}, layout = 'page', breadcrumb = ~{::breadcrumb})}"
  xmlns:th="https://www.thymeleaf.org"
>
  <th:block th:fragment="breadcrumb">
    <span>
      <a href="/">[[#{breadcrumb.home}]]</a>
    </span>
    <span>瞬间</span>
  </th:block>

  <div id="page-moments" class="ps-lg-2" th:fragment="content">
    <header class="moments-header mb-4">
      <h1 class="d-flex align-items-center gap-2 mb-0">
        <i class="fa fa-bolt text-warning"></i>
        <span>瞬间</span>
      </h1>
    </header>

    <section
      class="moments-tags card card-body border-0 shadow-sm mb-4"
      th:if="${not #lists.isEmpty(tags)}"
    >
      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="text-muted small me-2">标签筛选</span>
        <a
          class="btn btn-sm"
          th:classappend="${param.tag == null ? ' btn-primary text-white' : ' btn-outline-secondary'}"
          th:href="@{/moments}"
        >
          全部
        </a>
        <a
          class="btn btn-sm"
          th:each="tag : ${tags}"
          th:href="${tag.permalink != null ? tag.permalink : '/moments?tag=' + tag.name}"
          th:classappend="${param.tag != null and #lists.contains(param.tag, tag.name) ? ' btn-primary text-white' : ' btn-outline-secondary'}"
        >
          <span th:text="${tag.name}"></span>
          <span class="badge bg-transparent text-muted ms-1" th:text="${tag.momentCount}"></span>
        </a>
      </div>
    </section>

    <section class="moments-list">
      <ul
        class="list-unstyled moments-timeline"
        th:unless="${#lists.isEmpty(moments.items)}"
      >
        <li
          class="moment-item card card-body border-0 shadow-sm mb-4"
          th:each="moment : ${moments.items}"
          th:with="content=${moment.spec.content}"
        >
          <div
            class="moment-meta d-flex flex-wrap gap-3 small text-muted mb-3"
            th:with="author=${moment.owner}, stats=${moment.stats}"
          >
            <span th:if="${moment.spec.releaseTime != null}">
              <i class="far fa-clock me-1"></i>
              [[${#dates.format(moment.spec.releaseTime,'yyyy-MM-dd HH:mm')}]]
            </span>
            <span class="d-flex align-items-center" th:if="${author != null}">
              <img
                th:if="${author.avatar != null}"
                th:src="${author.avatar}"
                alt="author-avatar"
                class="rounded-circle me-2"
                width="24"
                height="24"
                loading="lazy"
              />
              <i class="far fa-user me-1" th:unless="${author.avatar != null}"></i>
              [[${author.displayName != null ? author.displayName : author.name}]]
            </span>
            <span th:if="${stats != null}">
              <i class="far fa-comment-dots me-1"></i>
              [[${stats.totalComment}]] 评论
            </span>
            <span th:if="${stats != null}">
              <i class="far fa-thumbs-up me-1"></i>
              [[${stats.upvote}]] 赞
            </span>
          </div>

          <div
            class="moment-content mb-3"
            th:if="${not #strings.isEmpty(content.html)}"
            th:utext="${content.html}"
          ></div>

          <div
            class="moment-media row g-3"
            th:if="${not #lists.isEmpty(content.medium)}"
          >
            <th:block th:each="momentItem, iterStat : ${content.medium}">
              <div
                class="col-12"
                th:classappend="${#lists.size(content.medium) > 1 ? ' col-md-6' : ''}"
              >
                <figure class="moment-media-item mb-0">
                  <img
                    class="img-fluid rounded"
                    th:if="${momentItem.type.name == 'PHOTO'}"
                    th:src="${momentItem.url}"
                    th:alt="${momentItem.name != null ? momentItem.name : 'moment-photo-' + iterStat.count}"
                    loading="lazy"
                  />
                  <video
                    class="w-100 rounded"
                    th:if="${momentItem.type.name == 'VIDEO'}"
                    th:src="${momentItem.url}"
                    controls
                  ></video>
                  <audio
                    class="w-100"
                    th:if="${momentItem.type.name == 'AUDIO'}"
                    th:src="${momentItem.url}"
                    controls
                  ></audio>
                </figure>
              </div>
            </th:block>
          </div>

          <div
            class="moment-tags mt-3"
            th:if="${not #lists.isEmpty(moment.spec.tags)}"
          >
            <a
              class="badge bg-light text-muted me-2 mb-2 text-decoration-none"
              th:each="momentTag : ${moment.spec.tags}"
              th:href="@{/moments(tag=${momentTag})}"
            >
              # [[${momentTag}]]
            </a>
          </div>

          <div class="moment-footer d-flex justify-content-between align-items-center mt-3">
            <span
              class="small text-muted"
              th:if="${moment.metadata != null and moment.metadata.creationTimestamp != null}"
            >
              [[${#dates.format(moment.metadata.creationTimestamp,'yyyy-MM-dd HH:mm')}]]
            </span>
            <a
              class="btn btn-link text-decoration-none p-0 fw-semibold"
              th:href="@{'/moments/' + ${moment.metadata.name}}"
            >
              查看详情
              <i class="fas fa-arrow-right ms-1"></i>
            </a>
          </div>
        </li>
      </ul>
    </section>

    <nav
      class="moments-pagination mt-4"
      aria-label="Moments Pagination"
      th:if="${moments.hasPrevious() || moments.hasNext()}"
    >
      <ul class="pagination justify-content-center align-items-center gap-2">
        <li
          class="page-item"
          th:classappend="${moments.hasPrevious() ? '' : ' disabled'}"
        >
          <a
            class="page-link"
            th:if="${moments.hasPrevious()}"
            th:href="@{${moments.prevUrl}}"
            rel="prev"
          >
            <i class="fas fa-angle-left me-1"></i>
            上一页
          </a>
          <span class="page-link" th:unless="${moments.hasPrevious()}">上一页</span>
        </li>

        <li class="page-item disabled">
          <span class="page-link bg-transparent border-0 text-muted">
            第 [[${moments.page}]] / [[${moments.totalPages}]] 页
          </span>
        </li>

        <li
          class="page-item"
          th:classappend="${moments.hasNext() ? '' : ' disabled'}"
        >
          <a
            class="page-link"
            th:if="${moments.hasNext()}"
            th:href="@{${moments.nextUrl}}"
            rel="next"
          >
            下一页
            <i class="fas fa-angle-right ms-1"></i>
          </a>
          <span class="page-link" th:unless="${moments.hasNext()}">下一页</span>
        </li>
      </ul>
    </nav>
  </div>
</html>
